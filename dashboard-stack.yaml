version: "3.8"

services:
  dashboard-backend:
    image: dashboard-backend:latest
    build:
      context: ./backend
      dockerfile: docker/Dockerfile
    environment:
      NODE_ENV: production
      PORT: 3001
      DATABASE_URL: postgresql://dashboard:${DB_PASSWORD}@postgres:5432/dashboard_db
      REDIS_URL: redis://redis:6379
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      FRONTEND_URL: https://dashboard.exageradosclub.com
    networks:
      - rede
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.http.routers.dashboard-api.rule=Host(`api-dashboard.exageradosclub.com`)
        - traefik.http.routers.dashboard-api.entrypoints=websecure
        - traefik.http.routers.dashboard-api.tls.certresolver=letsencryptresolver
        - traefik.http.routers.dashboard-api.priority=100
        - traefik.http.services.dashboard-api.loadbalancer.server.port=3001

  dashboard-frontend:
    image: dashboard-frontend:latest
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      NEXT_PUBLIC_API_URL: https://api-dashboard.exageradosclub.com
      NEXT_PUBLIC_WS_URL: wss://api-dashboard.exageradosclub.com
    networks:
      - rede
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.http.routers.dashboard.rule=Host(`dashboard.exageradosclub.com`)
        - traefik.http.routers.dashboard.entrypoints=websecure
        - traefik.http.routers.dashboard.tls.certresolver=letsencryptresolver
        - traefik.http.routers.dashboard.priority=100
        - traefik.http.services.dashboard.loadbalancer.server.port=3000

networks:
  rede:
    external: true
