version: "3.8"

services:
  dashboard-backend:
    image: dashboard-backend:latest
    environment:
      NODE_ENV: production
      PORT: 3001
      DATABASE_URL: postgresql://dashboard:${DB_PASSWORD}@postgres_postgres:5432/dashboard_db
      REDIS_URL: redis://redis_redis:6379
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      FRONTEND_URL: https://dash.utmia.com.br
    networks:
      - rede
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.http.routers.dash-api.rule=Host(`api-dash.utmia.com.br`)
        - traefik.http.routers.dash-api.entrypoints=websecure
        - traefik.http.routers.dash-api.tls.certresolver=letsencryptresolver
        - traefik.http.routers.dash-api.priority=100
        - traefik.http.services.dash-api.loadbalancer.server.port=3001

  dashboard-frontend:
    image: dashboard-frontend:latest
    environment:
      NEXT_PUBLIC_API_URL: https://api-dash.utmia.com.br
      NEXT_PUBLIC_WS_URL: wss://api-dash.utmia.com.br
    networks:
      - rede
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.http.routers.dash-frontend.rule=Host(`dash.utmia.com.br`)
        - traefik.http.routers.dash-frontend.entrypoints=websecure
        - traefik.http.routers.dash-frontend.tls.certresolver=letsencryptresolver
        - traefik.http.routers.dash-frontend.priority=100
        - traefik.http.services.dash-frontend.loadbalancer.server.port=3000

networks:
  rede:
    external: true
