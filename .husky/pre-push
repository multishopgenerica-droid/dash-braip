#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "๐ [PRE-PUSH] Verificaรงรฃo completa antes do push..."
echo ""

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

ERRORS=0

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 1. VERIFICAR BRANCH DE DESTINO
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
current_branch=$(git branch --show-current)
echo "๐ Branch atual: $current_branch"

# Bloquear push direto para main/master
if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
    # Verificar se hรก proteรงรฃo de branch
    echo -e "${YELLOW}โ๏ธ  Push direto para $current_branch!${NC}"
    echo "   Considere usar uma feature branch e abrir PR."
    # Nรฃo bloqueia, mas avisa
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 2. RODAR TESTES COMPLETOS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "๐งช Rodando testes completos..."

if [ -f "package.json" ]; then
    if grep -q "\"test\":" package.json; then
        echo "   Executando: npm test"
        if ! npm test 2>/dev/null; then
            echo -e "${RED}โ Testes falharam!${NC}"
            ERRORS=$((ERRORS + 1))
        else
            echo -e "${GREEN}โ Testes passaram${NC}"
        fi
    else
        echo -e "${YELLOW}โ๏ธ  Script de teste nรฃo encontrado em package.json${NC}"
    fi
elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
    if command -v pytest &> /dev/null; then
        echo "   Executando: pytest"
        if ! pytest 2>/dev/null; then
            echo -e "${RED}โ Testes falharam!${NC}"
            ERRORS=$((ERRORS + 1))
        else
            echo -e "${GREEN}โ Testes passaram${NC}"
        fi
    fi
elif [ -f "go.mod" ]; then
    echo "   Executando: go test ./..."
    if ! go test ./... 2>/dev/null; then
        echo -e "${RED}โ Testes falharam!${NC}"
        ERRORS=$((ERRORS + 1))
    else
        echo -e "${GREEN}โ Testes passaram${NC}"
    fi
elif [ -f "Cargo.toml" ]; then
    echo "   Executando: cargo test"
    if ! cargo test 2>/dev/null; then
        echo -e "${RED}โ Testes falharam!${NC}"
        ERRORS=$((ERRORS + 1))
    else
        echo -e "${GREEN}โ Testes passaram${NC}"
    fi
elif [ -f "composer.json" ]; then
    if [ -f "vendor/bin/phpunit" ]; then
        echo "   Executando: phpunit"
        if ! ./vendor/bin/phpunit 2>/dev/null; then
            echo -e "${RED}โ Testes falharam!${NC}"
            ERRORS=$((ERRORS + 1))
        else
            echo -e "${GREEN}โ Testes passaram${NC}"
        fi
    fi
else
    echo -e "${YELLOW}โ๏ธ  Framework de testes nรฃo detectado${NC}"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 3. VERIFICAR BUILD (se aplicรกvel)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "๐จ Verificando build..."

if [ -f "package.json" ]; then
    if grep -q "\"build\":" package.json; then
        echo "   Executando: npm run build"
        if ! npm run build 2>/dev/null; then
            echo -e "${RED}โ Build falhou!${NC}"
            ERRORS=$((ERRORS + 1))
        else
            echo -e "${GREEN}โ Build passou${NC}"
        fi
    fi
elif [ -f "Cargo.toml" ]; then
    echo "   Executando: cargo build"
    if ! cargo build 2>/dev/null; then
        echo -e "${RED}โ Build falhou!${NC}"
        ERRORS=$((ERRORS + 1))
    else
        echo -e "${GREEN}โ Build passou${NC}"
    fi
elif [ -f "go.mod" ]; then
    echo "   Executando: go build"
    if ! go build ./... 2>/dev/null; then
        echo -e "${RED}โ Build falhou!${NC}"
        ERRORS=$((ERRORS + 1))
    else
        echo -e "${GREEN}โ Build passou${NC}"
    fi
else
    echo -e "${GREEN}โ Build nรฃo aplicรกvel${NC}"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 4. RODAR AUTOMATED_REVIEW.sh (Se existir)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "๐ Verificando com AUTOMATED_REVIEW.sh..."

if [ -f "AUTOMATED_REVIEW.sh" ]; then
    echo "   Executando review automatizado..."
    if ! ./AUTOMATED_REVIEW.sh --ci 2>/dev/null; then
        echo -e "${YELLOW}โ๏ธ  AUTOMATED_REVIEW.sh encontrou avisos${NC}"
        # Nรฃo bloqueia, sรณ avisa
    else
        echo -e "${GREEN}โ Review passou${NC}"
    fi
else
    echo -e "${YELLOW}โ๏ธ  AUTOMATED_REVIEW.sh nรฃo encontrado${NC}"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# RESULTADO FINAL
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}โ PRE-PUSH FALHOU! $ERRORS erro(s) encontrado(s).${NC}"
    echo ""
    echo "Corrija os erros antes de fazer push."
    echo "Para bypass em emergรชncia (NรO RECOMENDADO): git push --no-verify"
    exit 1
else
    echo -e "${GREEN}โ PRE-PUSH PASSOU! Cรณdigo pronto para push.${NC}"
    exit 0
fi
