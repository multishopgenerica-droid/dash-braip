#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” [PRE-COMMIT] Verificando qualidade do cÃ³digo..."
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CORES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

ERRORS=0

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 1. VERIFICAR SECRETS (CRÃTICO!)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "ğŸ” [1/6] Verificando secrets..."

# PadrÃµes de secrets
SECRETS_PATTERN="(password|passwd|pwd|secret|api_key|apikey|api-key|token|auth|credential|private_key|privatekey|access_key|accesskey)(\s*[:=]\s*['\"][^'\"]{8,}['\"])"

# Verificar apenas arquivos staged
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|ts|jsx|tsx|py|php|java|go|rs|rb|env|json|yml|yaml|xml|properties|ini|conf|config)$' || true)

if [ -n "$STAGED_FILES" ]; then
    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            # Ignorar arquivos de exemplo
            if echo "$file" | grep -qE '\.example|\.sample|\.template'; then
                continue
            fi
            
            # Verificar secrets
            if grep -iE "$SECRETS_PATTERN" "$file" 2>/dev/null | grep -v "process.env\|os.environ\|getenv\|ENV\[" > /dev/null; then
                echo -e "${RED}âŒ SECRETS DETECTADOS em: $file${NC}"
                echo "   Remova credenciais hardcoded e use variÃ¡veis de ambiente!"
                ERRORS=$((ERRORS + 1))
            fi
        fi
    done
fi

# Verificar se .env estÃ¡ sendo commitado
if git diff --cached --name-only | grep -E '^\.env$|^\.env\.local$|^\.env\.production$' > /dev/null; then
    echo -e "${RED}âŒ TENTATIVA DE COMMIT DE .env!${NC}"
    echo "   Arquivos .env NUNCA devem ser commitados!"
    ERRORS=$((ERRORS + 1))
fi

[ $ERRORS -eq 0 ] && echo -e "${GREEN}âœ… Nenhum secret detectado${NC}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 2. VERIFICAR BUGS_FIXED.md (ProteÃ§Ã£o contra regressÃ£o)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo "ğŸ›¡ï¸ [2/6] Verificando BUGS_FIXED.md..."

if [ -f "BUGS_FIXED.md" ]; then
    STAGED_FILES=$(git diff --cached --name-only)
    
    for file in $STAGED_FILES; do
        # Verificar se arquivo estÃ¡ listado em BUGS_FIXED.md
        if grep -q "$file" BUGS_FIXED.md 2>/dev/null; then
            echo -e "${YELLOW}âš ï¸  ATENÃ‡ÃƒO: $file estÃ¡ em BUGS_FIXED.md!${NC}"
            echo "   Este arquivo teve bugs crÃ­ticos corrigidos."
            echo "   Certifique-se de nÃ£o reintroduzir os problemas."
            echo ""
            echo "   Bugs relacionados:"
            grep -A 3 "$file" BUGS_FIXED.md | head -10
            echo ""
            # NÃ£o bloqueia, mas avisa fortemente
        fi
    done
    echo -e "${GREEN}âœ… VerificaÃ§Ã£o de BUGS_FIXED.md concluÃ­da${NC}"
else
    echo -e "${YELLOW}âš ï¸  BUGS_FIXED.md nÃ£o encontrado${NC}"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 3. LINT (Detecta stack e roda linter apropriado)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo "ğŸ“ [3/6] Executando lint..."

# Detectar stack e rodar lint
if [ -f "package.json" ]; then
    # Node.js
    if command -v npx &> /dev/null; then
        if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f ".eslintrc.yml" ] || grep -q "eslintConfig" package.json 2>/dev/null; then
            STAGED_JS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$' | tr '\n' ' ')
            if [ -n "$STAGED_JS" ]; then
                echo "   Rodando ESLint..."
                if ! npx eslint $STAGED_JS --max-warnings=0 2>/dev/null; then
                    echo -e "${RED}âŒ ESLint encontrou erros!${NC}"
                    ERRORS=$((ERRORS + 1))
                else
                    echo -e "${GREEN}âœ… ESLint passou${NC}"
                fi
            fi
        fi
    fi
elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
    # Python
    STAGED_PY=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' | tr '\n' ' ')
    if [ -n "$STAGED_PY" ]; then
        if command -v ruff &> /dev/null; then
            echo "   Rodando Ruff..."
            if ! ruff check $STAGED_PY 2>/dev/null; then
                echo -e "${RED}âŒ Ruff encontrou erros!${NC}"
                ERRORS=$((ERRORS + 1))
            else
                echo -e "${GREEN}âœ… Ruff passou${NC}"
            fi
        elif command -v flake8 &> /dev/null; then
            echo "   Rodando Flake8..."
            if ! flake8 $STAGED_PY 2>/dev/null; then
                echo -e "${RED}âŒ Flake8 encontrou erros!${NC}"
                ERRORS=$((ERRORS + 1))
            else
                echo -e "${GREEN}âœ… Flake8 passou${NC}"
            fi
        fi
    fi
elif [ -f "composer.json" ]; then
    # PHP
    if [ -f "vendor/bin/phpcs" ]; then
        STAGED_PHP=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.php$' | tr '\n' ' ')
        if [ -n "$STAGED_PHP" ]; then
            echo "   Rodando PHP_CodeSniffer..."
            if ! ./vendor/bin/phpcs $STAGED_PHP 2>/dev/null; then
                echo -e "${RED}âŒ PHPCS encontrou erros!${NC}"
                ERRORS=$((ERRORS + 1))
            else
                echo -e "${GREEN}âœ… PHPCS passou${NC}"
            fi
        fi
    fi
elif [ -f "go.mod" ]; then
    # Go
    if command -v golangci-lint &> /dev/null; then
        echo "   Rodando golangci-lint..."
        if ! golangci-lint run 2>/dev/null; then
            echo -e "${RED}âŒ golangci-lint encontrou erros!${NC}"
            ERRORS=$((ERRORS + 1))
        else
            echo -e "${GREEN}âœ… golangci-lint passou${NC}"
        fi
    fi
elif [ -f "Cargo.toml" ]; then
    # Rust
    if command -v cargo &> /dev/null; then
        echo "   Rodando cargo clippy..."
        if ! cargo clippy -- -D warnings 2>/dev/null; then
            echo -e "${RED}âŒ Clippy encontrou erros!${NC}"
            ERRORS=$((ERRORS + 1))
        else
            echo -e "${GREEN}âœ… Clippy passou${NC}"
        fi
    fi
else
    echo -e "${YELLOW}âš ï¸  Linter nÃ£o configurado para esta stack${NC}"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 4. FORMATAÃ‡ÃƒO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo "ğŸ¨ [4/6] Verificando formataÃ§Ã£o..."

if [ -f "package.json" ]; then
    if command -v npx &> /dev/null && ([ -f ".prettierrc" ] || [ -f ".prettierrc.json" ] || [ -f "prettier.config.js" ]); then
        STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx|json|css|scss|md)$' | tr '\n' ' ')
        if [ -n "$STAGED_FILES" ]; then
            echo "   Verificando Prettier..."
            if ! npx prettier --check $STAGED_FILES 2>/dev/null; then
                echo -e "${YELLOW}âš ï¸  FormataÃ§Ã£o inconsistente. Rodando prettier --write...${NC}"
                npx prettier --write $STAGED_FILES 2>/dev/null
                git add $STAGED_FILES
                echo -e "${GREEN}âœ… Arquivos formatados e adicionados ao commit${NC}"
            else
                echo -e "${GREEN}âœ… FormataÃ§Ã£o OK${NC}"
            fi
        fi
    fi
elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
    if command -v black &> /dev/null; then
        STAGED_PY=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' | tr '\n' ' ')
        if [ -n "$STAGED_PY" ]; then
            echo "   Verificando Black..."
            if ! black --check $STAGED_PY 2>/dev/null; then
                echo -e "${YELLOW}âš ï¸  FormataÃ§Ã£o inconsistente. Rodando black...${NC}"
                black $STAGED_PY 2>/dev/null
                git add $STAGED_PY
                echo -e "${GREEN}âœ… Arquivos formatados e adicionados ao commit${NC}"
            else
                echo -e "${GREEN}âœ… FormataÃ§Ã£o OK${NC}"
            fi
        fi
    fi
elif [ -f "go.mod" ]; then
    STAGED_GO=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.go$' | tr '\n' ' ')
    if [ -n "$STAGED_GO" ]; then
        echo "   Rodando gofmt..."
        gofmt -w $STAGED_GO 2>/dev/null
        git add $STAGED_GO
        echo -e "${GREEN}âœ… Go formatado${NC}"
    fi
elif [ -f "Cargo.toml" ]; then
    echo "   Rodando cargo fmt..."
    cargo fmt 2>/dev/null
    git add -u 2>/dev/null
    echo -e "${GREEN}âœ… Rust formatado${NC}"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 5. TYPE CHECK (Se aplicÃ¡vel)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo "ğŸ”· [5/6] Verificando tipos..."

if [ -f "tsconfig.json" ]; then
    if command -v npx &> /dev/null; then
        echo "   Rodando TypeScript..."
        if ! npx tsc --noEmit 2>/dev/null; then
            echo -e "${RED}âŒ TypeScript encontrou erros de tipo!${NC}"
            ERRORS=$((ERRORS + 1))
        else
            echo -e "${GREEN}âœ… TypeScript passou${NC}"
        fi
    fi
elif [ -f "pyproject.toml" ] && grep -q "mypy\|pyright" pyproject.toml 2>/dev/null; then
    if command -v mypy &> /dev/null; then
        echo "   Rodando MyPy..."
        if ! mypy . --ignore-missing-imports 2>/dev/null; then
            echo -e "${YELLOW}âš ï¸  MyPy encontrou avisos (nÃ£o bloqueante)${NC}"
        else
            echo -e "${GREEN}âœ… MyPy passou${NC}"
        fi
    fi
else
    echo -e "${GREEN}âœ… Type check nÃ£o aplicÃ¡vel ou nÃ£o configurado${NC}"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 6. TESTES RÃPIDOS (Se configurados para pre-commit)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo "ğŸ§ª [6/6] Verificando testes..."

# Verificar se existe arquivo de configuraÃ§Ã£o para rodar testes no pre-commit
if [ -f ".run-tests-precommit" ]; then
    echo "   Rodando testes (configurado em .run-tests-precommit)..."
    
    if [ -f "package.json" ]; then
        if ! npm test -- --passWithNoTests --bail 2>/dev/null; then
            echo -e "${RED}âŒ Testes falharam!${NC}"
            ERRORS=$((ERRORS + 1))
        else
            echo -e "${GREEN}âœ… Testes passaram${NC}"
        fi
    elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
        if ! pytest --tb=short -q 2>/dev/null; then
            echo -e "${RED}âŒ Testes falharam!${NC}"
            ERRORS=$((ERRORS + 1))
        else
            echo -e "${GREEN}âœ… Testes passaram${NC}"
        fi
    fi
else
    echo -e "${GREEN}âœ… Testes serÃ£o executados no CI (nÃ£o configurado para pre-commit)${NC}"
    echo "   Dica: Crie .run-tests-precommit para rodar testes localmente"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RESULTADO FINAL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}âŒ PRE-COMMIT FALHOU! $ERRORS erro(s) encontrado(s).${NC}"
    echo ""
    echo "Corrija os erros acima antes de commitar."
    echo "Para bypass em emergÃªncia (NÃƒO RECOMENDADO): git commit --no-verify"
    exit 1
else
    echo -e "${GREEN}âœ… PRE-COMMIT PASSOU! CÃ³digo aprovado para commit.${NC}"
    exit 0
fi
