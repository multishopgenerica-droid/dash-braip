#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VALIDADOR DE CONVENTIONAL COMMITS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

commit_msg=$(cat "$1")

# PadrÃ£o: tipo(escopo): descriÃ§Ã£o
# Tipos vÃ¡lidos: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert
pattern="^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\([a-zA-Z0-9_-]+\))?(!)?: .{1,100}$"

# Permitir mensagens de merge
merge_pattern="^Merge "

# Permitir WIP temporÃ¡rio (mas avisar)
wip_pattern="^(WIP|wip|Wip)"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "ğŸ“ Validando mensagem de commit..."

# Verificar se Ã© merge
if echo "$commit_msg" | grep -qE "$merge_pattern"; then
    echo -e "${GREEN}âœ… Commit de merge detectado${NC}"
    exit 0
fi

# Verificar WIP
if echo "$commit_msg" | grep -qE "$wip_pattern"; then
    echo -e "${YELLOW}âš ï¸  Commit WIP detectado. Lembre-se de fazer squash antes do PR!${NC}"
    exit 0
fi

# Validar formato
if ! echo "$commit_msg" | head -1 | grep -qE "$pattern"; then
    echo -e "${RED}âŒ Mensagem de commit invÃ¡lida!${NC}"
    echo ""
    echo "Formato esperado: tipo(escopo): descriÃ§Ã£o"
    echo ""
    echo "Tipos vÃ¡lidos:"
    echo "  feat     â†’ Nova funcionalidade"
    echo "  fix      â†’ CorreÃ§Ã£o de bug"
    echo "  docs     â†’ DocumentaÃ§Ã£o"
    echo "  style    â†’ FormataÃ§Ã£o (nÃ£o altera cÃ³digo)"
    echo "  refactor â†’ RefatoraÃ§Ã£o"
    echo "  test     â†’ Testes"
    echo "  chore    â†’ ManutenÃ§Ã£o"
    echo "  perf     â†’ Performance"
    echo "  ci       â†’ CI/CD"
    echo "  build    â†’ Build system"
    echo "  revert   â†’ Reverter commit"
    echo ""
    echo "Exemplos vÃ¡lidos:"
    echo "  feat(auth): add password reset"
    echo "  fix(api): resolve timeout issue"
    echo "  docs: update README"
    echo "  refactor(user)!: change API response format"
    echo ""
    echo "Sua mensagem: $commit_msg"
    exit 1
fi

echo -e "${GREEN}âœ… Mensagem de commit vÃ¡lida${NC}"
exit 0
