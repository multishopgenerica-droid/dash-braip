#!/bin/bash
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ PRE-DEPLOY CHECKS - Sistema Dash Braip
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Executa TODAS as verificaรงรตes antes de permitir deploy
# USO: ./PRE_DEPLOY_CHECKS.sh
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

ERRORS=0
WARNINGS=0

echo ""
echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${YELLOW}โ   ๐ PRE-DEPLOY CHECKS - Sistema Dash Braip                                        โ${NC}"
echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 1: Git Status
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "${YELLOW}[1/7] Verificando Git status...${NC}"
if [ -d ".git" ]; then
    UNCOMMITTED=$(git status --porcelain | wc -l)
    if [ "$UNCOMMITTED" -gt 0 ]; then
        echo -e "${RED}   โ $UNCOMMITTED arquivo(s) nรฃo commitados${NC}"
        ((ERRORS++))
    else
        echo -e "${GREEN}   โ Git limpo - todos arquivos commitados${NC}"
    fi
else
    echo -e "${YELLOW}   โ๏ธ Nรฃo รฉ um repositรณrio Git${NC}"
    ((WARNINGS++))
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 2: Backend Lint
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "${YELLOW}[2/7] Verificando Lint do Backend...${NC}"
if [ -d "backend" ] && [ -f "backend/package.json" ]; then
    cd backend
    if grep -q "\"lint\"" package.json; then
        if npm run lint > /dev/null 2>&1; then
            echo -e "${GREEN}   โ Backend lint passou${NC}"
        else
            echo -e "${RED}   โ Backend lint falhou${NC}"
            ((ERRORS++))
        fi
    else
        echo -e "${YELLOW}   โ๏ธ Script lint nรฃo encontrado no backend${NC}"
        ((WARNINGS++))
    fi
    cd ..
elif [ -f "package.json" ]; then
    if grep -q "\"lint\"" package.json; then
        if npm run lint > /dev/null 2>&1; then
            echo -e "${GREEN}   โ Lint passou${NC}"
        else
            echo -e "${RED}   โ Lint falhou${NC}"
            ((ERRORS++))
        fi
    else
        echo -e "${YELLOW}   โ๏ธ Script lint nรฃo encontrado${NC}"
        ((WARNINGS++))
    fi
else
    echo -e "${YELLOW}   โ๏ธ Backend nรฃo encontrado${NC}"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 3: Frontend Lint
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "${YELLOW}[3/7] Verificando Lint do Frontend...${NC}"
if [ -d "frontend" ] && [ -f "frontend/package.json" ]; then
    cd frontend
    if grep -q "\"lint\"" package.json; then
        if npm run lint > /dev/null 2>&1; then
            echo -e "${GREEN}   โ Frontend lint passou${NC}"
        else
            echo -e "${RED}   โ Frontend lint falhou${NC}"
            ((ERRORS++))
        fi
    else
        echo -e "${YELLOW}   โ๏ธ Script lint nรฃo encontrado no frontend${NC}"
        ((WARNINGS++))
    fi
    cd ..
else
    echo -e "${YELLOW}   โ๏ธ Frontend separado nรฃo encontrado${NC}"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 4: TypeScript Compile
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "${YELLOW}[4/7] Verificando TypeScript...${NC}"
if [ -f "backend/tsconfig.json" ] || [ -f "tsconfig.json" ]; then
    TSCONFIG=$([ -f "backend/tsconfig.json" ] && echo "backend" || echo ".")
    cd $TSCONFIG
    if npx tsc --noEmit > /dev/null 2>&1; then
        echo -e "${GREEN}   โ TypeScript compilou sem erros${NC}"
    else
        echo -e "${RED}   โ TypeScript tem erros de compilaรงรฃo${NC}"
        ((ERRORS++))
    fi
    cd - > /dev/null
else
    echo -e "${YELLOW}   โ๏ธ TypeScript nรฃo configurado${NC}"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 5: Testes
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "${YELLOW}[5/7] Verificando Testes...${NC}"
BACKEND_DIR=$([ -d "backend" ] && echo "backend" || echo ".")
if [ -f "$BACKEND_DIR/package.json" ]; then
    cd $BACKEND_DIR
    if grep -q "\"test\"" package.json; then
        TEST_SCRIPT=$(grep "\"test\"" package.json | head -1)
        if [[ ! "$TEST_SCRIPT" =~ "no test" ]]; then
            if npm test > /dev/null 2>&1; then
                echo -e "${GREEN}   โ Testes passaram${NC}"
            else
                echo -e "${RED}   โ Testes falharam${NC}"
                ((ERRORS++))
            fi
        else
            echo -e "${YELLOW}   โ๏ธ Nenhum teste configurado${NC}"
            ((WARNINGS++))
        fi
    fi
    cd - > /dev/null
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 6: Variรกveis de Ambiente
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "${YELLOW}[6/7] Verificando variรกveis de ambiente...${NC}"
ENV_FILE=$([ -f "backend/.env" ] && echo "backend/.env" || echo ".env")
if [ -f "$ENV_FILE" ]; then
    # Verificar variรกveis crรญticas
    MISSING_VARS=0
    for VAR in DATABASE_URL NODE_ENV; do
        if ! grep -q "^$VAR=" "$ENV_FILE"; then
            echo -e "${RED}   โ Faltando: $VAR${NC}"
            ((MISSING_VARS++))
        fi
    done
    if [ $MISSING_VARS -eq 0 ]; then
        echo -e "${GREEN}   โ Variรกveis crรญticas presentes${NC}"
    else
        ((ERRORS++))
    fi
else
    echo -e "${RED}   โ Arquivo .env nรฃo encontrado${NC}"
    ((ERRORS++))
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 7: Docker Build Test
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "${YELLOW}[7/7] Verificando Docker build...${NC}"
if [ -f "docker-compose.yml" ] || [ -f "docker-compose.yaml" ]; then
    if docker compose config > /dev/null 2>&1; then
        echo -e "${GREEN}   โ docker-compose.yml vรกlido${NC}"
    else
        echo -e "${RED}   โ docker-compose.yml invรกlido${NC}"
        ((ERRORS++))
    fi
else
    echo -e "${YELLOW}   โ๏ธ docker-compose.yml nรฃo encontrado${NC}"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# RESULTADO FINAL
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"

if [ $ERRORS -eq 0 ]; then
    echo ""
    echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${GREEN}โ   โ TODAS AS VERIFICAรรES PASSARAM - PODE FAZER DEPLOY!                     โ${NC}"
    echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    if [ $WARNINGS -gt 0 ]; then
        echo -e "${YELLOW}   โ๏ธ $WARNINGS aviso(s) - revisar se necessรกrio${NC}"
    fi
    exit 0
else
    echo ""
    echo -e "${RED}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${RED}โ   โ DEPLOY BLOQUEADO - $ERRORS ERRO(S) ENCONTRADO(S)                           โ${NC}"
    echo -e "${RED}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    echo -e "${RED}   Corrija os erros acima antes de fazer deploy!${NC}"
    exit 1
fi
