#!/bin/bash
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# RUNBOOK: clear-cache.sh - Limpa cache (Redis, Memcached, etc)
# Multi-Agent System v6.2 - Bulletproof Edition
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set -e

CACHE_TYPE="${1:-all}"  # redis, memcached, cdn, all

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ   ๐งน RUNBOOK: Clear Cache                                                     โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# Carregar variรกveis
if [ -f ".env" ]; then
    source .env 2>/dev/null || true
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# REDIS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

clear_redis() {
    echo "๐ด Limpando Redis..."
    
    REDIS_URL="${REDIS_URL:-redis://localhost:6379}"
    
    if command -v redis-cli &> /dev/null; then
        redis-cli -u "$REDIS_URL" FLUSHALL
        echo "   โ Redis limpo"
    elif command -v docker &> /dev/null && docker ps | grep -q redis; then
        docker exec $(docker ps -q -f name=redis) redis-cli FLUSHALL
        echo "   โ Redis limpo via Docker"
    else
        echo "   โ๏ธ Redis nรฃo encontrado"
    fi
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# MEMCACHED
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

clear_memcached() {
    echo "๐ก Limpando Memcached..."
    
    if command -v nc &> /dev/null; then
        echo "flush_all" | nc localhost 11211 2>/dev/null && echo "   โ Memcached limpo" || echo "   โ๏ธ Memcached nรฃo encontrado"
    else
        echo "   โ๏ธ netcat nรฃo instalado"
    fi
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# APPLICATION CACHE
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

clear_app_cache() {
    echo "๐ฆ Limpando cache da aplicaรงรฃo..."
    
    # Node.js
    if [ -d "node_modules/.cache" ]; then
        rm -rf node_modules/.cache
        echo "   โ node_modules/.cache limpo"
    fi
    
    # Next.js
    if [ -d ".next/cache" ]; then
        rm -rf .next/cache
        echo "   โ .next/cache limpo"
    fi
    
    # Laravel
    if [ -f "artisan" ]; then
        php artisan cache:clear 2>/dev/null || true
        php artisan config:clear 2>/dev/null || true
        php artisan view:clear 2>/dev/null || true
        echo "   โ Laravel cache limpo"
    fi
    
    # Django
    if [ -f "manage.py" ]; then
        python manage.py clearcache 2>/dev/null || true
        echo "   โ Django cache limpo"
    fi
    
    # Geral
    if [ -d ".cache" ]; then
        rm -rf .cache
        echo "   โ .cache limpo"
    fi
    
    if [ -d "tmp/cache" ]; then
        rm -rf tmp/cache/*
        echo "   โ tmp/cache limpo"
    fi
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# EXECUTAR
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

case $CACHE_TYPE in
    redis)
        clear_redis
        ;;
    memcached)
        clear_memcached
        ;;
    app)
        clear_app_cache
        ;;
    all)
        clear_redis
        clear_memcached
        clear_app_cache
        ;;
    *)
        echo "Uso: $0 [redis|memcached|app|all]"
        exit 1
        ;;
esac

echo ""
echo "โ Cache limpo com sucesso!"
