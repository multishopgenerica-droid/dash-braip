# QA Report - Modulo AUTH (Login Flow)
**Data:** 2026-02-18 14:45 (America/Sao_Paulo)
**Testador:** QA Engineer Senior (Automatizado)
**Ambiente:** Producao (https://dash.utmia.com.br)
**Metodo:** Playwright (browser real) + curl (API) + analise de codigo

---

## RESUMO EXECUTIVO

| Metrica | Valor |
|---------|-------|
| Testes executados | 25 |
| PASS | 17 |
| FAIL | 5 |
| WARN (seguranca) | 3 |
| Bugs criticos | 2 |
| Bugs moderados | 3 |
| Vulnerabilidades | 4 |

---

## SERVICOS VERIFICADOS

| Servico | URL | Status |
|---------|-----|--------|
| Frontend | https://dash.utmia.com.br | 200 OK |
| API | https://api-dash.utmia.com.br | 200 OK (health) |
| API Login | https://api-dash.utmia.com.br/api/auth/login | 200 OK |
| Docker Swarm | dashboard stack | 4/4 services UP |

---

## 1. TESTES DE API (curl)

### 1.1 Login com credenciais validas
**Status:** PASS
- POST /api/auth/login com email/senha corretos
- Retorna 200, `success: true`, user data + tokens (access + refresh)
- User: Administrador, role: ADMIN
- Access token expira em 15 minutos
- Refresh token expira em 7 dias

### 1.2 Login com senha errada
**Status:** PASS
- POST /api/auth/login com senha incorreta
- Retorna 401, `"Email ou senha invalidos"`
- Mensagem generica (nao revela se email existe) -- BOM

### 1.3 Login com email inexistente
**Status:** PASS
- POST /api/auth/login com email nao cadastrado
- Retorna 401, `"Email ou senha invalidos"`
- Mesma mensagem que senha errada -- BOM (evita enumeracao)

### 1.4 Login com email invalido
**Status:** PASS
- POST /api/auth/login com email mal formatado
- Retorna 400, `"Email invalido"` via Zod validation

### 1.5 Login com body vazio
**Status:** PASS
- POST /api/auth/login com `{}`
- Retorna 400, detalhes de validacao (email: Required, password: Required)

### 1.6 Endpoint /me com token valido
**Status:** PASS
- GET /api/auth/me com Bearer token
- Retorna user data sem campo password

### 1.7 Endpoint /me sem token
**Status:** PASS
- GET /api/auth/me sem header Authorization
- Retorna 401, `"Token de acesso nao fornecido"`

### 1.8 Endpoint /me com token invalido
**Status:** PASS
- GET /api/auth/me com token falsificado
- Retorna 401, `"Token invalido ou expirado"`

### 1.9 Refresh token
**Status:** PASS
- POST /api/auth/refresh com refreshToken valido
- Retorna novo par de tokens (access + refresh)

### 1.10 Logout
**Status:** PASS
- POST /api/auth/logout com token valido
- Retorna `"Logout realizado com sucesso"`

### 1.11 Access token ainda funciona apos logout
**Status:** FAIL (BUG-001)
- GET /api/auth/me APOS logout ainda retorna 200 com dados do usuario
- Access token JWT continua valido ate expirar (15 min)
- Ver BUG-001 abaixo

---

## 2. TESTES DE BROWSER (Playwright)

### 2.1 Pagina de login carrega
**Status:** PASS
- Titulo: "Dashboard Multi-Gateway"
- H2: "Dashboard Multi-Gateway"
- Subtitulo: "Entre com suas credenciais"
- Campo email (type=email): visivel
- Campo senha (type=password): visivel
- Botao "Entrar": visivel

### 2.2 Login com senha errada no browser
**Status:** FAIL (BUG-002)
- API retorna 401 corretamente
- Mensagem de erro NAO e exibida no formulario
- Pagina recarrega completamente, perdendo o estado do erro
- Ver BUG-002 abaixo

### 2.3 Login com credenciais corretas no browser
**Status:** PASS
- API retorna 200
- Redireciona para https://dash.utmia.com.br/
- Dashboard carrega com sidebar, menus, nome do usuario

### 2.4 Tokens salvos no localStorage
**Status:** PASS (com WARN de seguranca)
- accessToken salvo em localStorage
- refreshToken salvo em localStorage
- NENHUM cookie definido
- NENHUM dado em sessionStorage
- Ver VULN-001

### 2.5 Dashboard apos login - erros de console
**Status:** FAIL (BUG-003)
- 6 erros 500 nos endpoints de analytics:
  - GET /api/analytics/affiliates (x2)
  - GET /api/analytics/products-plans (x2)
  - GET /api/analytics/sales-by-source (x2)
- Chamadas duplicadas (possivelmente React StrictMode ou re-render)

---

## 3. BUGS ENCONTRADOS

### BUG-001: Access Token Valido Apos Logout (CRITICO)
**Severidade:** CRITICA
**Reproducao:**
1. Fazer login via POST /api/auth/login
2. Copiar o accessToken
3. Fazer logout via POST /api/auth/logout
4. Usar o accessToken copiado para acessar GET /api/auth/me
5. Resultado: retorna 200 com dados do usuario

**Root Cause:**
- Arquivo: `/root/sistema-dash-braip/backend/src/modules/auth/auth.middleware.ts` (linhas 8-44)
- O middleware `authMiddleware` apenas verifica a assinatura JWT via `verifyAccessToken()` e consulta se o usuario existe no banco
- NAO verifica se o token foi revogado/logout
- O logout apenas remove o refreshToken da tabela, mas o accessToken e um JWT stateless que permanece valido ate expirar

**Fix Sugerido:**
```typescript
// Opcao 1: Blacklist de tokens (Redis)
// No logout, adicionar accessToken ao Redis com TTL = tempo restante
// No authMiddleware, verificar se token esta na blacklist

// Opcao 2: Token versioning
// Adicionar campo tokenVersion no User
// No logout, incrementar tokenVersion
// No authMiddleware, verificar se tokenVersion no JWT bate com o do banco
```

**Impacto:** Se um token e interceptado ou roubado, o logout nao o invalida. O atacante tem 15 minutos de acesso mesmo apos o usuario fazer logout.

---

### BUG-002: Mensagem de Erro Nao Aparece no Login (CRITICO)
**Severidade:** CRITICA
**Reproducao:**
1. Acessar https://dash.utmia.com.br/login
2. Digitar email valido e senha errada
3. Clicar em "Entrar"
4. Resultado: pagina recarrega, campos ficam vazios, NENHUMA mensagem de erro

**Root Cause:**
- Arquivo: `/root/sistema-dash-braip/frontend/src/services/api.ts` (linhas 27-63)
- O interceptor de resposta do Axios intercepta QUALQUER resposta 401
- Quando o login retorna 401, o interceptor:
  1. Tenta fazer refresh token (nao existe, usuario nao esta logado)
  2. Falha no refresh, executa `window.location.href = "/login"` (linha 56)
  3. Isso causa HARD RELOAD da pagina
  4. O `handleSubmit` no `login/page.tsx` nunca recebe o erro para setar o state

**Fix Sugerido:**
```typescript
// Em api.ts, excluir rotas de auth do interceptor de 401:
api.interceptors.response.use(
  (response) => response,
  async (error) => {
    const originalRequest = error.config;

    // NAO interceptar 401 em rotas de autenticacao
    const isAuthRoute = originalRequest.url?.includes('/api/auth/login')
      || originalRequest.url?.includes('/api/auth/register')
      || originalRequest.url?.includes('/api/auth/refresh');

    if (error.response?.status === 401 && !originalRequest._retry && !isAuthRoute) {
      // ... logica de refresh token existente
    }

    return Promise.reject(error);
  }
);
```

**Impacto:** Usuarios que digitam a senha errada veem a pagina recarregar sem feedback, causando confusao. Podem pensar que o sistema esta com problema.

---

### BUG-003: Endpoints de Analytics Retornando 500 (MODERADO)
**Severidade:** MODERADA
**Endpoints afetados:**
- GET /api/analytics/affiliates
- GET /api/analytics/products-plans
- GET /api/analytics/sales-by-source

**Root Cause:**
- Arquivo: `/root/sistema-dash-braip/backend/src/modules/analytics/analytics.service.ts`
- Funcao `getAffiliateStats` (linha 421): query raw `$queryRawUnsafe` faz cast `s.commissions::jsonb` que falha quando o campo `commissions` e NULL ou string vazia
- Funcao `getSalesBySource` (linha 503): mesma logica com `s.commissions::text`
- Funcao `getProductsWithPlans` (linha 546): erro de Prisma `PrismaClientKnownRequestError`
- Logs mostram: erro do Prisma ao tentar processar os dados

**Fix Sugerido:**
```sql
-- Em getAffiliateStats, adicionar filtro para commissions nao-nulo:
WHERE s."gatewayConfigId" = $1
  AND s."transStatus" IN ('Aprovado', 'Pagamento Aprovado')
  AND s.commissions IS NOT NULL
  AND s.commissions::text != '[]'
  AND s.commissions::text != 'null'
```

**Impacto:** Dashboard mostra erros visuais nos widgets de afiliados, produtos/planos e vendas por fonte. Funcionalidade degradada mas nao bloqueante.

---

### BUG-004: Rate Limiter Muito Restritivo (MODERADO)
**Severidade:** MODERADA
**Detalhes:**
- Auth limiter: 10 tentativas em 15 minutos
- Apos 10 tentativas (incluindo corretas), bloqueia TODAS as tentativas
- Rate limit e global por IP (atras do Traefik, pode afetar todos os usuarios em NAT)

**Impacto:** Em ambientes com NAT/proxy compartilhado, um usuario pode bloquear o login de outros.

---

### BUG-005: Chamadas de API Duplicadas no Dashboard (BAIXO)
**Severidade:** BAIXA
**Detalhes:**
- Os 3 endpoints com 500 sao chamados 2x cada (6 erros no total)
- Possivelmente causado por React.StrictMode ou re-render desnecessario

**Impacto:** Dobra a carga no backend, piora performance.

---

## 4. VULNERABILIDADES DE SEGURANCA

### VULN-001: Tokens JWT em localStorage (XSS Vulnerability)
**Severidade:** ALTA
- Access token e refresh token armazenados em `localStorage`
- localStorage e acessivel via JavaScript (vulneravel a XSS)
- Nenhum cookie httpOnly e usado
- Se houver qualquer vulnerabilidade XSS, tokens podem ser roubados

**Recomendacao:** Armazenar refresh token em cookie httpOnly secure SameSite=Strict. Access token pode ficar em memoria (variavel JavaScript, nao localStorage).

---

### VULN-002: URL da API Hardcoded no Codigo (INFO)
**Severidade:** INFO
- Arquivo: `/root/sistema-dash-braip/frontend/src/services/api.ts` linha 3
- `const API_URL = "https://api-dash.utmia.com.br"` hardcoded
- `process.env.NEXT_PUBLIC_API_URL` definido no `.env.production` e `Dockerfile` mas NAO usado no codigo
- Impede uso de environments diferentes sem rebuild

**Recomendacao:** Alterar para `const API_URL = process.env.NEXT_PUBLIC_API_URL || "https://api-dash.utmia.com.br"`

---

### VULN-003: SQL Injection em Analytics (ALTA)
**Severidade:** ALTA
- Arquivo: `/root/sistema-dash-braip/backend/src/modules/analytics/analytics.service.ts`
- Funcoes `getAffiliateStats` (linha 416) e `getSalesBySource` (linha 499)
- Concatenacao direta de strings em queries SQL:
  ```typescript
  dateCondition = `AND s."transCreateDate" >= '${startDateStr}'::timestamp`
  ```
- Embora os valores venham de query params, nao ha sanitizacao

**Recomendacao:** Usar parametros posicionais ($2, $3) em vez de interpolacao de string.

---

### VULN-004: Backend .env com Credenciais de Desenvolvimento (MODERADA)
**Severidade:** MODERADA
- Arquivo: `/root/sistema-dash-braip/backend/.env` (no repositorio)
- Contem `NODE_ENV=development` e secrets de desenvolvimento
- JWT secrets fracos: `dev_access_secret_key_very_long_and_secure_123456`
- NOTA: Em producao (Docker Swarm), secrets reais sao injetados via environment no `dashboard-stack.yaml`
- POREM: o `.env` no repo pode confundir e ser usado acidentalmente

**Recomendacao:** Remover `.env` do repositorio (ja esta no .gitignore, mas arquivo existe localmente). Usar apenas `.env.example`.

---

## 5. INVESTIGACAO: "Salvando em arquivo dev?"

### Resultado da investigacao:

**1. Arquivo `.env.production` do frontend:**
- Caminho: `/root/sistema-dash-braip/frontend/.env.production`
- Conteudo: URLs de producao (corretas)
- Este arquivo E commitado no repositorio -- NAO e um problema em si, pois contem apenas URLs publicas

**2. NAO existem arquivos `.env.development` ou `.env.local`:**
- Nenhum arquivo `.env.development` encontrado
- Nenhum arquivo `.env.local` encontrado
- O `.gitignore` corretamente ignora `.env.local` e `.env.*.local`

**3. URL da API HARDCODED (principal achado):**
- O arquivo `/root/sistema-dash-braip/frontend/src/services/api.ts` tem a URL `https://api-dash.utmia.com.br` HARDCODED na linha 3
- A variavel de ambiente `NEXT_PUBLIC_API_URL` e definida em 3 lugares (`.env.production`, `.env.example`, `Dockerfile`) mas NUNCA e usada no codigo
- Isso significa que mudar o `.env.production` NAO muda a URL da API -- o valor hardcoded sempre prevalece

**4. Backend .env com NODE_ENV=development:**
- O arquivo `/root/sistema-dash-braip/backend/.env` tem `NODE_ENV=development`
- MAS em producao (Docker Swarm), o `dashboard-stack.yaml` sobrescreve para `NODE_ENV: production`
- O `.env` local NAO afeta producao

**5. Dockerfile do frontend:**
- Define `NEXT_PUBLIC_API_URL` no build time (correto para Next.js)
- Mas como `api.ts` nao usa `process.env`, essa env e ignorada

**Conclusao:** O frontend NAO esta "salvando em arquivo dev". A URL da API esta corretamente apontando para producao. O problema real e que a URL esta HARDCODED no codigo fonte em vez de usar variavel de ambiente, o que e uma ma pratica (mas funciona corretamente em producao).

---

## 6. HEADERS DE SEGURANCA

### API (api-dash.utmia.com.br)
| Header | Valor | Status |
|--------|-------|--------|
| Helmet (CSP) | default-src 'self' | OK |
| CORS | Origin: dash.utmia.com.br only | OK |
| X-Frame-Options | SAMEORIGIN | OK |
| X-Content-Type-Options | nosniff | OK |
| Strict-Transport-Security | max-age=15552000 | OK |
| Referrer-Policy | no-referrer | OK |
| Rate Limiting | ratelimit headers presentes | OK |

### Frontend (dash.utmia.com.br)
| Header | Valor | Status |
|--------|-------|--------|
| HSTS | NAO presente | WARN |
| X-Frame-Options | NAO presente | WARN |
| CSP | NAO presente | WARN |

**Nota:** Headers de seguranca no frontend dependem da configuracao do Traefik/Next.js.

---

## 7. ACOES RECOMENDADAS (por prioridade)

### P0 (Critico - Corrigir Imediatamente)
1. **BUG-002:** Corrigir interceptor Axios para nao interceptar 401 em rotas de login
2. **VULN-003:** Substituir SQL injection em analytics por parametros posicionais

### P1 (Alto - Corrigir Esta Semana)
3. **VULN-001:** Migrar refresh token para cookie httpOnly
4. **BUG-001:** Implementar blacklist de tokens no Redis apos logout
5. **BUG-003:** Corrigir queries de analytics para tratar commissions NULL

### P2 (Moderado - Corrigir Este Sprint)
6. **VULN-002:** Usar process.env.NEXT_PUBLIC_API_URL em api.ts
7. **BUG-004:** Ajustar rate limiter (separar login valido de invalido)
8. **VULN-004:** Remover .env do repo, usar apenas .env.example

### P3 (Baixo - Backlog)
9. **BUG-005:** Investigar chamadas de API duplicadas no dashboard
10. Adicionar headers de seguranca no frontend via Traefik
11. Adicionar `middleware.ts` no Next.js para protecao server-side das rotas

---

## 8. ARQUIVOS RELEVANTES

| Arquivo | Descricao |
|---------|-----------|
| `/root/sistema-dash-braip/frontend/src/services/api.ts` | Axios config + interceptors (BUG-002, VULN-001, VULN-002) |
| `/root/sistema-dash-braip/frontend/src/app/(auth)/login/page.tsx` | Pagina de login |
| `/root/sistema-dash-braip/frontend/src/services/auth.service.ts` | Service de auth (localStorage) |
| `/root/sistema-dash-braip/frontend/src/stores/auth.store.ts` | Zustand store de auth |
| `/root/sistema-dash-braip/frontend/src/app/providers.tsx` | Providers com loadUser |
| `/root/sistema-dash-braip/frontend/src/app/(dashboard)/layout.tsx` | Layout do dashboard (auth check) |
| `/root/sistema-dash-braip/backend/src/modules/auth/auth.middleware.ts` | Middleware de auth (BUG-001) |
| `/root/sistema-dash-braip/backend/src/modules/auth/auth.service.ts` | Service de auth backend |
| `/root/sistema-dash-braip/backend/src/modules/analytics/analytics.service.ts` | Analytics (BUG-003, VULN-003) |
| `/root/sistema-dash-braip/backend/src/shared/middlewares/rate-limit.middleware.ts` | Rate limiter (BUG-004) |
| `/root/sistema-dash-braip/frontend/.env.production` | Env de producao frontend |
| `/root/sistema-dash-braip/dashboard-stack.yaml` | Deploy Docker Swarm |
